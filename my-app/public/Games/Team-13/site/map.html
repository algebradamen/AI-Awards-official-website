<!DOCTYPE html>
<html lang="no">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOR-TRACK // GEOJSON FEED</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Google Font for Tech Look -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-green: #0aff0a;
            --neon-orange: #ffaa00;
            --dark-bg: #1a1a1a;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #050505;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #eee;
            overflow: hidden;
        }

        /* --- CRT / TECH OVERLAY EFFEKTER --- */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.3;
        }

        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle, rgba(0, 0, 0, 0) 60%, rgba(0, 0, 0, 0.6) 100%);
            pointer-events: none;
            z-index: 9998;
        }

        /* KARTET */
        #map {
            height: 100vh;
            width: 100vw;
            z-index: 1;
            background: #050505;
        }

        .leaflet-marker-icon {
            transition: transform 2s linear;
        }

        /* ZOOM CONTROL STYLING */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3) !important;
            margin-top: 60px !important;
            margin-left: 20px !important;
        }

        .leaflet-control-zoom a {
            background-color: #222 !important;
            color: #fff !important;
            border-bottom: 1px solid #444 !important;
        }

        .leaflet-control-zoom a:hover {
            background-color: #333 !important;
        }

        /* TILBAKE KNAPP */
        .back-home-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background-color: #222;
            color: #fff;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-home-btn:hover {
            background-color: #333;
            border-color: #666;
        }

        /* SIDEBAR */
        .sidebar {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 280px;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid #333;
            padding: 20px;
            z-index: 1000;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .sidebar h2 {
            margin-top: 0;
            font-family: 'Share Tech Mono', monospace;
            font-size: 20px;
            color: #fff;
            border-bottom: 1px solid #444;
            padding-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            letter-spacing: 1px;
        }

        .live-dot {
            height: 8px;
            width: 8px;
            background-color: #ff3b3b;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 5px #ff3b3b;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0.5;
            }
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .filter-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .filter-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .filter-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-item label {
            cursor: pointer;
            color: #ddd;
            font-size: 14px;
            font-weight: 500;
        }

        .filter-item input[type="checkbox"] {
            accent-color: var(--neon-blue);
        }

        .track-btn {
            background: transparent;
            border: 1px solid #555;
            color: #ccc;
            cursor: pointer;
            padding: 5px 10px;
            font-size: 11px;
            border-radius: 4px;
            transition: 0.2s;
            text-transform: uppercase;
            font-weight: bold;
        }

        .track-btn:hover {
            background: #fff;
            color: #000;
            border-color: #fff;
        }

        /* EGENDEFINERTE IKONER */
        .custom-marker {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 40px;
            height: 40px;
        }

        .marker-pin {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(30, 30, 30, 0.9);
            border: 2px solid currentColor;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            position: relative;
            z-index: 2;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .marker-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: transparent;
            border: 2px solid currentColor;
            opacity: 0;
            animation: pulse-ring 2s infinite;
            z-index: 1;
        }

        @keyframes pulse-ring {
            0% {
                width: 30px;
                height: 30px;
                opacity: 0.8;
                border-width: 2px;
            }

            100% {
                width: 80px;
                height: 80px;
                opacity: 0;
                border-width: 0px;
            }
        }

        /* POPUP STYLING */
        .leaflet-popup-content-wrapper {
            background: #222;
            color: #fff;
            border-radius: 6px;
            border: 1px solid #444;
            font-family: 'Segoe UI', sans-serif;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .leaflet-popup-tip {
            background: #222;
        }

        .popup-header {
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
            margin-bottom: 10px;
        }

        .popup-content h3 {
            margin: 0;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
            font-size: 12px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 6px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-label {
            color: #999;
            font-size: 10px;
            display: block;
            margin-bottom: 2px;
        }

        .stat-value {
            color: #fff;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <div class="scanlines"></div>
    <div class="vignette"></div>

    <a href="index.html" class="back-home-btn">
        <span>&#8592;</span> Tilbake
    </a>

    <div class="sidebar">
        <h2>
            NOR-TRACK
            <span style="font-size: 12px; vertical-align: middle; color: #aaa; font-family: sans-serif;">
                LIVE <span class="live-dot"></span>
            </span>
        </h2>
        <div style="font-size: 12px; color: #888; margin-bottom: 15px;">
            Status: <span id="dataStatus" style="color: #ccc;">Kobler til...</span>
        </div>

        <div class="filter-group" id="filterContainer"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. KART OPPSETT ---
        const map = L.map('map', {
            center: [65.0, 13.0],
            zoom: 5,
            zoomControl: true,
            attributionControl: false,
            maxBounds: [[50, -20], [85, 50]],
            minZoom: 4,
            maxZoom: 18
        });

        map.zoomControl.setPosition('topleft');

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // --- 2. KONFIGURASJON & FALLBACK DATA ---

        const ANIMAL_TEMPLATES = [
            { species: "Hval", emoji: "ðŸ‹", type: "ocean", color: "#00f3ff", speed: "12 km/t" },
            { species: "Sel", emoji: "ðŸ¦­", type: "ocean", color: "#0088ff", speed: "8 km/t" },
            { species: "GrÃ¥ulv", emoji: "ðŸº", type: "land", color: "#ff5500", speed: "6 km/t" },
            { species: "Gaupe", emoji: "ðŸ±", type: "land", color: "#ff8800", speed: "0 km/t" },
            { species: "Fjellrev", emoji: "ðŸ¦Š", type: "land", color: "#ffaa00", speed: "4 km/t" },
            { species: "Elg", emoji: "ðŸ¦Œ", type: "land", color: "#d2691e", speed: "2 km/t" },
            { species: "IsbjÃ¸rn", emoji: "ðŸ»â€â„ï¸", type: "svalbard", color: "#ffffff", speed: "5 km/t" },
            // NYTT DYR LAGT TIL HER: JERV
            { species: "Jerv", emoji: "ðŸ¦¡", type: "land", color: "#cd5c5c", speed: "7 km/t" }
        ];

        const ANIMAL_NAMES = [
            "Balder", "Freya", "Odin", "Thor", "Loke", "Frigg", "Tyr", "Heimdall",
            "Luna", "Sol", "MÃ¥ne", "Stjerne", "Sky", "Storm", "Varg", "BjÃ¸rn",
            "Ulf", "Ravn", "Hauk", "Falk", "Ã˜rn", "Frost", "Vinter",
            "Sommer", "HÃ¸st", "VÃ¥r", "Natt", "Dag", "Bella", "Max", "Charlie",
            "Molly", "Buddy", "Daisy", "Rocky", "Simba", "Nala", "Leo", "Mia",
            "Tassen", "Bamse", "Pia", "Kira", "Zelda", "Felix", "Casper"
        ];

        const IGNORE_KEYWORDS = [
            "blomst", "flower", "plante", "plant", "flora",
            "tre", "tree", "rose", "tulipan", "gress", "busk"
        ];

        const FALLBACK_GEOJSON = {
            "type": "FeatureCollection",
            "features": [
                { "type": "Feature", "geometry": { "type": "Point", "coordinates": [9.0, 69.0] }, "properties": { "id": 1, "emoji": "ðŸ‹", "species": "Hval", "type": "ocean", "color": "#00f3ff" } },
                { "type": "Feature", "geometry": { "type": "Point", "coordinates": [4.0, 64.0] }, "properties": { "id": 2, "emoji": "ðŸ¦­", "species": "Sel", "type": "ocean", "color": "#0088ff" } },
                { "type": "Feature", "geometry": { "type": "Point", "coordinates": [11.8, 61.5] }, "properties": { "id": 3, "emoji": "ðŸº", "species": "GrÃ¥ulv", "type": "land", "color": "#ff5500" } },
                { "type": "Feature", "geometry": { "type": "Point", "coordinates": [16.0, 78.0] }, "properties": { "id": 4, "emoji": "ðŸ»â€â„ï¸", "species": "IsbjÃ¸rn", "type": "svalbard", "color": "#ffffff" } }
            ]
        };

        // --- 3. DATA & LOGIKK ---
        let animals = [];
        const markers = {};
        const lines = {};
        const histories = {};

        const BOUNDS = {
            SVALBARD: { minLat: 76.5, maxLat: 80.5, minLng: 10.0, maxLng: 28.0 },
            NORWAY_LAND: { minLat: 57.5, maxLat: 71.5, minLng: 4.5, maxLng: 32.0 },
            OCEAN: { minLat: 57.0, maxLat: 76.0, minLng: -10.0, maxLng: 35.0 }
        };

        const AGDER_BOUNDS = { minLat: 57.8, maxLat: 59.5, minLng: 6.0, maxLng: 9.6 };

        const LAND_BOXES = [
            { name: "South", minLat: 57.5, maxLat: 64.0, minLng: 4.5, maxLng: 13.0 },
            { name: "Mid", minLat: 64.0, maxLat: 67.5, minLng: 9.5, maxLng: 15.0 },
            { name: "North", minLat: 67.5, maxLat: 71.5, minLng: 12.0, maxLng: 32.0 }
        ];

        function isIgnored(properties) {
            const text = (
                (properties.name || "") + " " +
                (properties.species || "") + " " +
                (properties.type || "")
            ).toLowerCase();
            return IGNORE_KEYWORDS.some(keyword => text.includes(keyword));
        }

        function generateExtraAnimals(count) {
            const extras = [];
            const regions = ['svalbard', 'north_land', 'ocean', 'mid_norway', 'west_norway'];

            for (let i = 0; i < count; i++) {
                const region = regions[i % regions.length];
                let lat, lng;

                if (region === 'svalbard') {
                    lat = 78.0 + Math.random() * 1.5;
                    lng = 15.0 + Math.random() * 5.0;
                } else if (region === 'north_land') {
                    lat = 69.0 + Math.random() * 1.5;
                    lng = 23.0 + Math.random() * 5.0;
                } else if (region === 'mid_norway') {
                    lat = 63.5 + Math.random() * 1.5;
                    lng = 10.0 + Math.random() * 2.0;
                } else if (region === 'west_norway') {
                    lat = 60.5 + Math.random() * 1.5;
                    lng = 5.5 + Math.random() * 2.0;
                } else {
                    lat = 65.0 + Math.random() * 5.0;
                    lng = 2.0 + Math.random() * 5.0;
                }

                extras.push({
                    type: "Feature",
                    geometry: { type: "Point", coordinates: [lng, lat] },
                    properties: {
                        id: 9000 + i,
                        status: "Signal Aktivt"
                    }
                });
            }
            return extras;
        }

        function initApp(geoJsonData) {
            let candidates = geoJsonData.features.filter(f => !isIgnored(f.properties));
            const buckets = { agder: [], others: [] };

            candidates.forEach(f => {
                const lat = f.geometry.coordinates[1];
                const lng = f.geometry.coordinates[0];
                const inAgder = lat >= AGDER_BOUNDS.minLat && lat <= AGDER_BOUNDS.maxLat &&
                    lng >= AGDER_BOUNDS.minLng && lng <= AGDER_BOUNDS.maxLng;

                if (inAgder) buckets.agder.push(f);
                else buckets.others.push(f);
            });

            const extraAnimals = generateExtraAnimals(20);
            const finalFeatures = [
                ...buckets.agder.slice(0, 10),
                ...buckets.others,
                ...extraAnimals
            ];

            animals = finalFeatures.map((f, index) => {
                const startLat = f.geometry.coordinates[1];
                const startLng = f.geometry.coordinates[0];

                let detectedRegion = 'ocean';
                const isIn = (lat, lng, b) => lat >= b.minLat && lat <= b.maxLat && lng >= b.minLng && lng <= b.maxLng;

                if (isIn(startLat, startLng, BOUNDS.SVALBARD)) detectedRegion = 'svalbard';
                else {
                    for (let box of LAND_BOXES) {
                        if (isIn(startLat, startLng, box)) {
                            detectedRegion = 'land';
                            break;
                        }
                    }
                }

                const validTemplates = ANIMAL_TEMPLATES.filter(t => t.type === detectedRegion);
                const templatesToUse = validTemplates.length > 0 ? validTemplates : ANIMAL_TEMPLATES;
                const randomTemplate = templatesToUse[Math.floor(Math.random() * templatesToUse.length)];

                const type = detectedRegion;
                const assignedName = ANIMAL_NAMES[index % ANIMAL_NAMES.length];

                return {
                    id: f.properties.id || (index + 1),
                    name: assignedName,
                    species: f.properties.species || randomTemplate.species,
                    emoji: f.properties.emoji || randomTemplate.emoji,
                    type: type,
                    color: f.properties.color || randomTemplate.color,
                    status: f.properties.status || "Aktiv",
                    speed: f.properties.speed || randomTemplate.speed,
                    lat: startLat,
                    lng: startLng
                };
            });

            animals.forEach(animal => {
                createAnimalMarker(animal);
                addToSidebar(animal);
            });

            startAnimationLoop();
        }

        // --- 4. DATA HENTING ---
        const statusSpan = document.getElementById('dataStatus');

        fetch('test2.geojson')
            .then(response => {
                if (!response.ok) throw new Error("Fil ikke funnet");
                return response.json();
            })
            .then(data => {
                console.log("Lastet test2.geojson suksessfullt!");
                statusSpan.innerText = "ONLINE";
                statusSpan.style.color = "#0aff0a";
                initApp(data);
            })
            .catch(error => {
                console.warn("Fant ikke 'test2.geojson', bruker intern fallback data.", error);
                statusSpan.innerText = "SIMULERING (NO DATA)";
                statusSpan.style.color = "#ffaa00";
                initApp(FALLBACK_GEOJSON);
            });


        // --- 5. FUNKSJONER ---

        function createPulsingIcon(emoji, color) {
            return L.divIcon({
                className: 'custom-marker',
                html: `
                    <div style="color: ${color}">
                        <div class="marker-pulse"></div>
                        <div class="marker-pin">${emoji}</div>
                    </div>
                `,
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });
        }

        function createAnimalMarker(animal) {
            const marker = L.marker([animal.lat, animal.lng], {
                icon: createPulsingIcon(animal.emoji, animal.color)
            });

            const popupHTML = `
                <div class="popup-header">
                    <h3>${animal.emoji} ${animal.name}</h3>
                    <small style="color:#aaa">${animal.species.toUpperCase()} // ID: #${1000 + animal.id}</small>
                </div>
                <div class="stat-grid">
                    <div class="stat-box"><span class="stat-label">STATUS</span><span class="stat-value" style="color:${animal.color}">${animal.status}</span></div>
                    <div class="stat-box"><span class="stat-label">FART</span><span class="stat-value">${animal.speed}</span></div>
                    <div class="stat-box"><span class="stat-label">TEMP</span><span class="stat-value">-2Â°C</span></div>
                    <div class="stat-box"><span class="stat-label">SIGNAL</span><span class="stat-value">100%</span></div>
                </div>
            `;
            marker.bindPopup(popupHTML);

            histories[animal.id] = [[animal.lat, animal.lng]];
            const line = L.polyline(histories[animal.id], {
                color: animal.color,
                weight: 3,
                opacity: 0.6,
                dashArray: '1, 10',
                className: 'animated-line'
            });

            markers[animal.id] = marker.addTo(map);
            lines[animal.id] = line.addTo(map);
        }

        function addToSidebar(animal) {
            const div = document.createElement('div');
            div.className = 'filter-item';
            div.innerHTML = `
                <div class="filter-controls">
                    <input type="checkbox" id="cb-${animal.id}" checked>
                    <label for="cb-${animal.id}" style="color:${animal.color}">${animal.emoji} ${animal.name}</label>
                </div>
                <button class="track-btn" onclick="trackAnimal(${animal.id})">ðŸŽ¯ TRACK</button>
            `;

            div.querySelector('input').addEventListener('change', (e) => {
                if (e.target.checked) {
                    map.addLayer(markers[animal.id]);
                    map.addLayer(lines[animal.id]);
                } else {
                    map.removeLayer(markers[animal.id]);
                    map.removeLayer(lines[animal.id]);
                }
            });

            document.getElementById('filterContainer').appendChild(div);
        }

        window.trackAnimal = function (id) {
            const marker = markers[id];
            map.flyTo(marker.getLatLng(), 14, {
                animate: true,
                duration: 1.5
            });
            setTimeout(() => {
                marker.openPopup();
            }, 1500);
        };

        // --- 6. BEVEGELSES-MOTOR ---

        function startAnimationLoop() {
            setInterval(() => {
                animals.forEach(animal => {
                    const moveLat = (Math.random() - 0.5) * 0.00005;
                    const moveLng = (Math.random() - 0.5) * 0.0001;

                    let newLat = animal.lat + moveLat;
                    let newLng = animal.lng + moveLng;

                    let allowed = false;
                    const isIn = (lat, lng, b) => lat >= b.minLat && lat <= b.maxLat && lng >= b.minLng && lng <= b.maxLng;

                    if (animal.type === 'svalbard') {
                        if (isIn(newLat, newLng, BOUNDS.SVALBARD)) allowed = true;
                    }
                    else if (animal.type === 'land') {
                        for (let box of LAND_BOXES) {
                            if (isIn(newLat, newLng, box)) {
                                allowed = true;
                                break;
                            }
                        }
                    }
                    else if (animal.type === 'ocean') {
                        if (isIn(newLat, newLng, BOUNDS.OCEAN)) {
                            allowed = true;
                            for (let box of LAND_BOXES) {
                                if (isIn(newLat, newLng, box)) {
                                    allowed = false;
                                    break;
                                }
                            }
                        }
                    }

                    if (!allowed) {
                        newLat = animal.lat;
                        newLng = animal.lng;
                    }

                    animal.lat = newLat;
                    animal.lng = newLng;

                    if (markers[animal.id]) {
                        markers[animal.id].setLatLng([newLat, newLng]);
                    }

                    if (histories[animal.id] && lines[animal.id]) {
                        if (newLat !== animal.lat || newLng !== animal.lng) {
                            const hist = histories[animal.id];
                            hist.push([newLat, newLng]);
                            if (hist.length > 20) hist.shift();
                            lines[animal.id].setLatLngs(hist);
                        }
                    }
                });
            }, 2000);
        }
    </script>
</body>

</html>